stages:          # List of stages for jobs, and their order of execution
  - config
  - notify
  - build
  - test
  - docker
  - deploy


image: python:3.10
build-backend:       # This job runs in the build stage, which runs first.
  stage: build
  script:
    - cd backend/
    - python -m venv venv
    - source venv/bin/activate
    - pip install -r requirements.txt
  artifacts:
    paths:
      - backend/venv/
      - backend/src/
      - backend/requirements.txt
  
lint-backend:
  stage: test
  script:
    - cd backend/
    - source venv/bin/activate
    - flake8 src/
  needs: 
    - build-backend

test-backend:
  services:
      - postgres
  variables:
      POSTGRES_HOST: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: microservices_db 
      POSTGRES_HOST_AUTH_METHOD: trust    
      DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/microservices_db"
      FLASK_ENV: "testing"

  stage: test
  script:
    - cd backend/
    - source venv/bin/activate
    - pytest src/
  needs: 
    - build-backend